VkForgePipelineLayout VkForge_CreateForgePipelineLayout(
    VkForgeLayout *forgeLayout,
    const char *pipelineName)
{
    assert(forgeLayout);
    assert(pipelineName);

    // Find the pipeline layout index for the given pipeline name
    uint32_t pipeline_layout_index = FindPipelineLayoutIndex(pipelineName);
    if (pipeline_layout_index == UINT32_MAX)
    {
        SDL_LogError(0, "Pipeline layout not found for pipeline: %s", pipelineName);
        exit(1);
    }

    // Get the pipeline layout design
    const VkForgeLayoutPipelineLayoutDesign *pipeline_design =
        VKFORGE_REFERENCED_LAYOUT_DESIGN.pipeline_layout_design_buffer[pipeline_layout_index];

    VkForgePipelineLayout pipelineLayout = {0};
    pipelineLayout.pipeline_layout_index = pipeline_layout_index;
    pipelineLayout.design = (VkForgeLayoutPipelineLayoutDesign *)pipeline_design;
    pipelineLayout.descriptor_set_count = pipeline_design->descriptorset_layout_design_count;

    // Create descriptor set layouts (only if there are any)
    for (uint32_t i = 0; i < pipeline_design->descriptorset_layout_design_count; i++)
    {
        const VkForgeLayoutDescriptorSetLayoutDesign *set_design =
            pipeline_design->descriptorset_layout_design_buffer[i];

        VkResult result = CreateDescriptorSetLayout(
            forgeLayout->device,
            set_design,
            &pipelineLayout.descriptor_set_layouts[i]);

        if (result != VK_SUCCESS)
        {
            SDL_LogError(0, "Failed to create descriptor set layout %u: %d", i, result);
            exit(1);
        }
    }

    // Create pipeline layout
    VkPipelineLayoutCreateInfo pipelineLayoutInfo = {
        .sType = VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO,
        .setLayoutCount = pipeline_design->descriptorset_layout_design_count,
        .pSetLayouts = pipelineLayout.descriptor_set_layouts};

    VkResult result = vkCreatePipelineLayout(
        forgeLayout->device,
        &pipelineLayoutInfo,
        NULL,
        &pipelineLayout.pipelineLayout);

    if (result != VK_SUCCESS)
    {
        SDL_LogError(0, "Failed to create pipeline layout: %d", result);
        exit(1);
    }

    // Only create descriptor pool and allocate sets if we have descriptor sets
    if (pipeline_design->descriptorset_layout_design_count > 0)
    {
        // Calculate descriptor pool requirements
        uint32_t pool_size_count = 0;
        VkDescriptorPoolSize pool_sizes[VKFORGE_MAX_DESCRIPTOR_BINDINGS] = {0};

        GetDescriptorPoolRequirements(pipeline_design, &pool_size_count, NULL);
        
        // Check if we actually have any descriptor bindings
        if (pool_size_count > 0)
        {
            GetDescriptorPoolRequirements(pipeline_design, NULL, pool_sizes);

            // Create descriptor pool
            VkDescriptorPoolCreateInfo poolInfo = {
                .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_POOL_CREATE_INFO,
                .maxSets = pipeline_design->descriptorset_layout_design_count,
                .poolSizeCount = pool_size_count,
                .pPoolSizes = pool_sizes};

            result = vkCreateDescriptorPool(
                forgeLayout->device,
                &poolInfo,
                NULL,
                &pipelineLayout.descriptor_pool);

            if (result != VK_SUCCESS)
            {
                SDL_LogError(0, "Failed to create descriptor pool: %d", result);
                vkDestroyPipelineLayout(forgeLayout->device, pipelineLayout.pipelineLayout, NULL);
                exit(1);
            }

            // Allocate descriptor sets
            VkDescriptorSetAllocateInfo allocInfo = {
                .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_SET_ALLOCATE_INFO,
                .descriptorPool = pipelineLayout.descriptor_pool,
                .descriptorSetCount = pipeline_design->descriptorset_layout_design_count,
                .pSetLayouts = pipelineLayout.descriptor_set_layouts};

            result = vkAllocateDescriptorSets(
                forgeLayout->device,
                &allocInfo,
                pipelineLayout.descriptor_sets);

            if (result != VK_SUCCESS)
            {
                SDL_LogError(0, "Failed to allocate descriptor sets: %d", result);
                vkDestroyDescriptorPool(forgeLayout->device, pipelineLayout.descriptor_pool, NULL);
                vkDestroyPipelineLayout(forgeLayout->device, pipelineLayout.pipelineLayout, NULL);
                exit(1);
            }
        }
        else
        {
            // No descriptor bindings needed, no pool required
            pipelineLayout.descriptor_pool = VK_NULL_HANDLE;
            // Initialize descriptor sets to NULL handles
            for (uint32_t i = 0; i < pipeline_design->descriptorset_layout_design_count; i++)
            {
                pipelineLayout.descriptor_sets[i] = VK_NULL_HANDLE;
            }
        }
    }
    else
    {
        // No descriptor sets needed
        pipelineLayout.descriptor_pool = VK_NULL_HANDLE;
        // No need to initialize descriptor_sets array since count is 0
    }

    SDL_Log("Created pipeline layout for pipeline: %s", pipelineName);
    return pipelineLayout;
}